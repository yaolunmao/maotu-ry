import{S as w,D as q,r as f,B as O,o as r,c as p,h as u,w as t,n as _,i as a,a5 as m,a6 as R,K as b,a7 as y,a8 as C,a9 as B,k as v,L as I,l as A,aa as H,m as K,ab as M,ac as N}from"./index-F5mM8V04.js";import{g as T}from"./project-RGje6Uw9.js";function G(i){return w({url:"/webtopo/svgnode/list",method:"get",params:i})}function J(i){return w({url:"/webtopo/svgnode",method:"post",data:i})}function Q(i){return w({url:"/webtopo/svgnode/unbind",method:"delete",data:i})}const W={class:"w-1/1"},X={key:0},x=q({__name:"device-bind",props:{handItemInfo:{type:Object,default:()=>{}},projectId:{type:String,default:""}},setup(i){const s=i,h=f(!1),c=f([]),k=f([]),j=f(),g=O({device_id:{required:!0,message:"请选择设备",trigger:"change"},device_prop:[{required:!0,message:"请选择设备属性",trigger:"change"}],bind_node_prop:[{required:!0,message:"请选择图形属性",trigger:"change"}]}),V=()=>{Promise.all([T(s.projectId),G({projectId:s.projectId,svgNodeId:s.handItemInfo.id})]).then(d=>{console.log(d,35,s.handItemInfo),k.value=d[0].data.deviceList.map(e=>({id:String(e.deviceId),name:String(e.deviceName),prop_list:e.deviceDictList.map(l=>l)})),c.value=d[1].data.map(e=>({bind_node_id:e.svgNodeId,bind_node_prop:e.svgNodeProp,device_id:String(e.deviceId),device_prop:e.deviceProp}))})},$=()=>{console.log("点击了配置按钮，查询当前图形目前已经绑定的设备"),V(),h.value=!0},D=d=>{var e;return((e=k.value.find(l=>l.id==d))==null?void 0:e.prop_list)??[]},U=()=>{let d=[];console.log(s.handItemInfo.props);for(const e in s.handItemInfo.props)d.push({label:s.handItemInfo.props[e].title,value:`props.${e}.val`});return d},F=d=>{if(d){N.error("必须先完成上一个步骤！");return}c.value.push({bind_node_id:s.handItemInfo.id,bind_node_prop:"",device_id:"",device_prop:"",bind_btn_state:!0})},P=(d,e,l)=>{var n;(n=j.value)==null||n.validate((o,E)=>{if(o)z(d,e);else{let S=!0;for(const L in E)L.split(".")[0]==`[${l}]`&&(S=!1);if(S){z(d,e);return}console.log("error submit!",E)}})},z=(d,e)=>{console.log("触发了设备绑定",d,e),d==1?J({projectId:s.projectId,deviceId:e.device_id,svgNodeId:e.bind_node_id,svgNodeProp:e.bind_node_prop,deviceProp:e.device_prop}).then(l=>{N.success("绑定成功"),V()}):Q({projectId:s.projectId,deviceId:e.device_id,svgNodeId:e.bind_node_id,svgNodeProp:e.bind_node_prop,deviceProp:e.device_prop}).then(l=>{N.success("解除绑定成功"),V()})};return(d,e)=>(r(),p("div",W,[u(a(m),{class:"w-1/1",onClick:$},{default:t(()=>[_("点击配置")]),_:1}),u(a(M),{modelValue:h.value,"onUpdate:modelValue":e[1]||(e[1]=l=>h.value=l),title:"配置",direction:"ltr"},{default:t(()=>[u(a(R),{ref_key:"ruleFormRef",ref:j,rules:g,model:c.value},{default:t(()=>[(r(!0),p(b,null,I(c.value,(l,n)=>(r(),p("div",{key:n},[l.bind_node_id==s.handItemInfo.id?(r(),p("div",X,[u(a(y),{label:"选择设备",size:"small",prop:`[${n}].device_id`,rules:g.device_id},{default:t(()=>[u(a(C),{modelValue:l.device_id,"onUpdate:modelValue":o=>l.device_id=o,placeholder:"请选择设备",size:"small",onChange:o=>l.device_prop="",disabled:!l.bind_btn_state},{default:t(()=>[(r(!0),p(b,null,I(k.value,o=>(r(),v(a(B),{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange","disabled"])]),_:2},1032,["prop","rules"]),u(a(y),{label:"设备属性",size:"small",prop:`[${n}].device_prop`,rules:g.device_prop},{default:t(()=>[u(a(C),{modelValue:l.device_prop,"onUpdate:modelValue":o=>l.device_prop=o,placeholder:"请选择设备属性",size:"small",disabled:!l.bind_btn_state},{default:t(()=>[(r(!0),p(b,null,I(D(l.device_id),o=>(r(),v(a(B),{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1032,["prop","rules"]),u(a(y),{label:"图形属性",size:"small",prop:`[${n}].bind_node_prop`,rules:g.bind_node_prop},{default:t(()=>[u(a(C),{modelValue:l.bind_node_prop,"onUpdate:modelValue":o=>l.bind_node_prop=o,placeholder:"请选择图形属性",size:"small",disabled:!l.bind_btn_state},{default:t(()=>[(r(!0),p(b,null,I(U(),o=>(r(),v(a(B),{key:o.label,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1032,["prop","rules"]),A("div",null,[l.bind_btn_state?(r(),v(a(m),{key:0,type:"success",size:"small",class:"w-1/1",onClick:o=>P(1,l,n)},{default:t(()=>[_("绑定")]),_:2},1032,["onClick"])):(r(),v(a(m),{key:1,type:"danger",size:"small",class:"w-1/1",onClick:o=>P(2,l,n)},{default:t(()=>[_("解绑")]),_:2},1032,["onClick"]))]),u(a(H))])):K("",!0)]))),128))]),_:1},8,["rules","model"]),u(a(m),{type:"primary",onClick:e[0]||(e[0]=l=>{var n;return F(((n=c.value[c.value.length-1])==null?void 0:n.bind_btn_state)??!1)}),class:"w-1/1",size:"small"},{default:t(()=>[_("新增")]),_:1})]),_:1},8,["modelValue"])]))}});export{x as _};
