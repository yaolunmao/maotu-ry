import{a as L,u as q,l as M}from"./svgnode-ecd8D-XT.js";import{g as O}from"./project-J1lw65wD.js";import{F as R,r as _,C as A,o as s,c as u,h as i,w as n,n as f,i as d,aM as g,aN as H,L as m,aO as V,aP as C,aQ as y,k as c,M as b,l as Q,aR as T,m as G,aS as J,a6 as N}from"./index-_GLIFr1R.js";const K={class:"w-1/1"},W={key:0},x=R({__name:"device-bind",props:{handItemInfo:{type:Object,default:()=>{}},projectId:{type:String,default:""}},setup(S){const t=S,I=_(!1),p=_([]),k=_([]),B=_(),v=A({device_id:{required:!0,message:"请选择设备",trigger:"change"},device_prop:[{required:!0,message:"请选择设备属性",trigger:"change"}],bind_node_prop:[{required:!0,message:"请选择图形属性",trigger:"change"}]}),h=()=>{Promise.all([O(t.projectId),M({projectId:t.projectId,svgNodeId:t.handItemInfo.id})]).then(a=>{console.log(a,35,t.handItemInfo),k.value=a[0].data.deviceList.map(e=>({id:String(e.deviceId),name:String(e.deviceName),prop_list:e.deviceDictList.map(l=>l)})),p.value=a[1].data.map(e=>({bind_node_id:e.svgNodeId,bind_node_prop:e.svgNodeProp,device_id:String(e.deviceId),device_prop:e.deviceProp}))})},$=()=>{console.log("点击了配置按钮，查询当前图形目前已经绑定的设备"),h(),I.value=!0},w=a=>{var e;return((e=k.value.find(l=>l.id==a))==null?void 0:e.prop_list)??[]},U=()=>{let a=[];console.log(t.handItemInfo.props);for(const e in t.handItemInfo.props)a.push({label:t.handItemInfo.props[e].title,value:`props.${e}.val`});return a},D=a=>{if(a){N.error("必须先完成上一个步骤！");return}p.value.push({bind_node_id:t.handItemInfo.id,bind_node_prop:"",device_id:"",device_prop:"",bind_btn_state:!0})},P=(a,e,l)=>{var r;(r=B.value)==null||r.validate((o,z)=>{if(o)j(a,e);else{let E=!0;for(const F in z)F.split(".")[0]==`[${l}]`&&(E=!1);if(E){j(a,e);return}console.log("error submit!",z)}})},j=(a,e)=>{console.log("触发了设备绑定",a,e),a==1?L({projectId:t.projectId,deviceId:e.device_id,svgNodeId:e.bind_node_id,svgNodeProp:e.bind_node_prop,deviceProp:e.device_prop}).then(l=>{N.success("绑定成功"),h()}):q({projectId:t.projectId,deviceId:e.device_id,svgNodeId:e.bind_node_id,svgNodeProp:e.bind_node_prop,deviceProp:e.device_prop}).then(l=>{N.success("解除绑定成功"),h()})};return(a,e)=>(s(),u("div",K,[i(d(g),{class:"w-1/1",onClick:$},{default:n(()=>[f("点击配置")]),_:1}),i(d(J),{modelValue:I.value,"onUpdate:modelValue":e[1]||(e[1]=l=>I.value=l),title:"配置",direction:"ltr"},{default:n(()=>[i(d(H),{ref_key:"ruleFormRef",ref:B,rules:v,model:p.value},{default:n(()=>[(s(!0),u(m,null,b(p.value,(l,r)=>(s(),u("div",{key:r},[l.bind_node_id==t.handItemInfo.id?(s(),u("div",W,[i(d(V),{label:"选择设备",size:"small",prop:`[${r}].device_id`,rules:v.device_id},{default:n(()=>[i(d(C),{modelValue:l.device_id,"onUpdate:modelValue":o=>l.device_id=o,placeholder:"请选择设备",size:"small",onChange:o=>l.device_prop="",disabled:!l.bind_btn_state},{default:n(()=>[(s(!0),u(m,null,b(k.value,o=>(s(),c(d(y),{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange","disabled"])]),_:2},1032,["prop","rules"]),i(d(V),{label:"设备属性",size:"small",prop:`[${r}].device_prop`,rules:v.device_prop},{default:n(()=>[i(d(C),{modelValue:l.device_prop,"onUpdate:modelValue":o=>l.device_prop=o,placeholder:"请选择设备属性",size:"small",disabled:!l.bind_btn_state},{default:n(()=>[(s(!0),u(m,null,b(w(l.device_id),o=>(s(),c(d(y),{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1032,["prop","rules"]),i(d(V),{label:"图形属性",size:"small",prop:`[${r}].bind_node_prop`,rules:v.bind_node_prop},{default:n(()=>[i(d(C),{modelValue:l.bind_node_prop,"onUpdate:modelValue":o=>l.bind_node_prop=o,placeholder:"请选择图形属性",size:"small",disabled:!l.bind_btn_state},{default:n(()=>[(s(!0),u(m,null,b(U(),o=>(s(),c(d(y),{key:o.label,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1032,["prop","rules"]),Q("div",null,[l.bind_btn_state?(s(),c(d(g),{key:0,type:"success",size:"small",class:"w-1/1",onClick:o=>P(1,l,r)},{default:n(()=>[f("绑定")]),_:2},1032,["onClick"])):(s(),c(d(g),{key:1,type:"danger",size:"small",class:"w-1/1",onClick:o=>P(2,l,r)},{default:n(()=>[f("解绑")]),_:2},1032,["onClick"]))]),i(d(T))])):G("",!0)]))),128))]),_:1},8,["rules","model"]),i(d(g),{type:"primary",onClick:e[0]||(e[0]=l=>{var r;return D(((r=p.value[p.value.length-1])==null?void 0:r.bind_btn_state)??!1)}),class:"w-1/1",size:"small"},{default:n(()=>[f("新增")]),_:1})]),_:1},8,["modelValue"])]))}});export{x as _};
